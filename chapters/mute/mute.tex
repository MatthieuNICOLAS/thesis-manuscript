\NumberThisInToc
\chapter{MUTE, un éditeur de texte web collaboratif P2P temps réel chiffré de bout en bout}
\minitoc
\label{chap:mute}

\input{chapters/mute/intro}

\section{Présentation}
% \input{chapters/mute/presentation}

\subsection{Objectifs}
\input{chapters/mute/objectifs}

\subsection{Fonctionnalités}
\input{chapters/mute/fonctionnalites}

\subsection{Architecture système}
\input{chapters/mute/architecture-sys}

\subsection{Architecture logicielle}
\input{chapters/mute/architecture-logicielle}

\section{Couche interface utilisateur}
\input{chapters/mute/interface-utilisateur}

\section{Couche réplication}

\subsection{Modèle de données du document texte}
\input{chapters/mute/modele-donnees-document}

\subsection{Module de livraison des opérations}
\input{chapters/mute/livraison-intro}

\subsubsection{Livraison des opérations en exactement un exemplaire}
\input{chapters/mute/livraison-exactly-once}

\subsubsection{Livraison de l'opération \emph{remove} après l'opération \emph{insert}}
\input{chapters/mute/livraison-remove-apres-insert}

\subsubsection{Livraison des opérations après l'opération \emph{rename} introduisant leur époque}
\input{chapters/mute/livraison-epoch-based}

\subsubsection{Livraison des opérations à terme}
\input{chapters/mute/livraison-eventual}

\subsection{Collaborateur-rices}
\input{chapters/mute/swim-intro}

\subsubsection{Mécanisme de détection des défaillances des pairs}
\input{chapters/mute/swim-defaillance}

\subsubsection{Mécanisme de dissémination des mises à jour du groupe}
\input{chapters/mute/swim-update-dissemination-intro}

\subsubsection{Modifications apportées}
\input{chapters/mute/swim-update-dissemination-modifs}

\subsubsection{Synthèse}
\input{chapters/mute/swim-synth}

\subsection{Curseurs}
\input{chapters/mute/curseurs}

% \subsection{Composition de CRDTs}

% \begin{itemize}
%   \item
% \end{itemize}

% \subsection{CRDT pour les styles}

% \begin{itemize}
%   \item Permettrait de se découpler de Markdown pour gérer le style du document
%   \item Permettrait de supporter un plus grand nombre d'options que Markdown ne le permet actuellement (couleurs, mise en page...)
% \end{itemize}

% \subsection{Évolution de schéma}
% \begin{itemize}
%   \item Cambria \cite{2021-cambria-schema-evolution}
% \end{itemize}

\section{Couche réseau}
\label{sec:mute-couche-reseau}

Pour permettre aux différents noeuds de communiquer, MUTE repose sur la librairie Netflux\footnote{\url{https://github.com/coast-team/netflux}}.
Développée au sein de l'équipe Coast, cette librairie permet de construire un réseau \ac{P2P} entre des navigateurs, mais aussi des bots.

\subsection{Établissement d'un réseau \ac{P2P} entre navigateurs}

Pour créer un réseau \ac{P2P} entre navigateurs, Netflux utilise la technologie \acf{WebRTC}.
\ac{WebRTC} est une API\footnote{\ac{API} : Interface de Programmation} de navigateur spécifiée en 2011, et en cours d'implémentation dans les différents navigateurs depuis 2013.
Elle permet de créer une connexion directe entre deux navigateurs pour échanger des médias audio et/ou vidéo, ou simplement des données.

Cette API utilise pour cela un ensemble de protocoles.
Ces protocoles réintroduisent des serveurs dans l'architecture système de MUTE.
Dans la \autoref{fig:architecture-systeme-webrtc}, nous représentons un réseau \ac{P2P} créé avec \ac{WebRTC} et les différents serveurs impliqués.

\begin{figure}[!ht]
  \centering
  \includegraphics[page=3, trim=7cm 3cm 4cm 2cm, clip, width=.7\linewidth]{img/mute-figures.pdf}
  \caption{Architecture système pour la couche réseau de MUTE}
  \label{fig:architecture-systeme-webrtc}
\end{figure}

Nous décrivons ci-dessous leur rôle respectif dans la collaboration.

\subsubsection{Serveur de signalisation}

Pour rejoindre un réseau \ac{P2P} déjà établi, un nouveau noeud a besoin de découvrir les noeuds déjà connectés et de pouvoir communiquer avec eux.
Le serveur de signalisation offre ces fonctionnalités.

Au moins un noeud du réseau \ac{P2P} doit maintenir une connexion avec le serveur de signalisation.
À sa connexion, un nouveau noeud contacte le serveur de signalisation.
Il est mis en relation avec un noeud du réseau \ac{P2P} par son intermédiaire et échange les différents messages de \ac{WebRTC} nécessaires à l'établissement d'une connexion \ac{P2P} entre eux.

Une fois cette première connexion \ac{P2P} établie, le nouveau noeud contacte et communique avec les autres noeuds par l'intermédiaire du premier noeud.
Il peut alors terminer sa connexion avec le serveur de signalisation.

\subsubsection{Serveur STUN}

Pour se connecter, les noeuds doivent s'échanger plusieurs informations logicielles et matérielles, notamment leur adresse IP publique respective.
Cependant, un noeud n'a pas accès à cette donnée lorsque son routeur utilise le protocole NAT.
Le noeud doit alors la récupérer.

Pour permettre aux noeuds de découvrir leur adresse IP publique, \ac{WebRTC} repose sur le protocole STUN.
Ce protocole consiste simplement à contacter un serveur tiers dédié à cet effet.
Ce serveur retourne en réponse au noeud qui le contacte son adresse IP publique.

\subsubsection{Serveur TURN}

Il est possible que des noeuds provenant de réseaux différents ne puissent établir une connexion \ac{P2P} directe entre eux, par exemple à cause de restrictions imposées par leur pare-feux respectifs.
Pour contourner ce cas de figure, \ac{WebRTC} utilise le protocole TURN.

Ce protocole consiste à utiliser un serveur tiers comme relais entre les noeuds.
Ainsi, les noeuds peuvent communiquer par son intermédiaire tout au long de la collaboration.
Les échanges sont chiffrés, afin que le serveur TURN ne représente pas une faille de sécurité.

\subsubsection{Rôle des serveurs}

Ainsi, \ac{WebRTC} implique l'utilisation de plusieurs serveurs.

Les serveurs de signalisation et STUN sont nécessaires pour permettre à de nouveaux noeuds de rejoindre la collaboration.
Autrement dit, leur rôle est ponctuel : une fois le réseau \ac{P2P} établit, les noeuds n'ont plus besoin d'eux.
Ces serveurs peuvent alors être coupés sans impacter la collaboration.

À l'inverse, les serveurs TURN jouent un rôle plus prédominant dans la collaboration.
Ils sont nécessaires dès lors que des noeuds proviennent de réseaux différents et sont alors requis tout au long de la collaboration.
Une panne de ces derniers entraverait la collaboration puisqu'elle résulterait en une partition des noeuds.
Il est donc primordial de s'assurer de la disponibilité et fiabilité de ces serveurs.

\subsection{Topologie réseau}

Netflux établit un réseau \ac{P2P} par document.
Chaque réseau \ac{P2P} est un réseau entièrement maillé : chaque noeud se connecte à l'ensemble des autres noeuds.

Cette topologie simple est adaptée à des groupes de petite taille, mais ne passe pas à l'échelle.
D'autres topologies limitant le nombre de connexions par noeuds, telle que celle décrite par \cite{2018-spray-nedelec}, pourraient être implémentées pour adresser cette limite.

% \subsection{Gestion des bots}

% \begin{itemize}
%   \item Pour faciliter la collaboration, MUTE propose l'utilisation de bots
%   \item Par exemple, un bot de stockage se contentant de suivre une collaboration et de stocker les opérations
%   \item De façon à permettre à un pair de récupérer la dernière version du document même si les autres collaborateur-rices sont actuellement déconnectés
%   \item Afin de réutiliser les structures de données implémentées, développés en NodeJS
%   \item Cependant, NodeJS ne supporte pas WebRTC nativement
%   \item Utilise alors des websockets
%   \item Netflux propose une couche d'abstraction permettant de communiquer avec un pair de manière uniforme, qu'il soit un navigateur ou un bot
% \end{itemize}

\section{Couche sécurité}
\label{sec:mute-couche-securite}

La couche sécurité a pour but de garantir l'authenticité et la confidentialité des messages échangés par les noeuds.
Pour cela, elle implémente un mécanisme de chiffrement de bout en bout.

Pour chiffrer les messages, MUTE utilise un mécanisme de chiffrement à base de clé de groupe.
Le protocole choisi est le protocole Burmester-Desmedt \cite{1995-burmester-desmedt}.
Il nécessite que chaque noeud possède une paire de clés de chiffrement et enregistre sa clé publique auprès d'un PKI\footnote{\acf{PKI} : Infrastructure de gestion de clés}.

Afin d'éviter qu'un \ac{PKI} malicieux n'effectue une attaque de l'homme au milieu sur la collaboration, les noeuds doivent vérifier le bon comportement des PKI de manière non-coordonnée.
À cet effet, MUTE implémente le mécanisme d'audit de PKI Trusternity \cite{2018-trusternity-short, 2018-trusternity-long}.
Son fonctionnement nécessite l'utilisation d'un registre publique sécurisé \emph{append-only}, \ie une blockchain.

L'architecture système nécessaire pour la couche sécurité est présentée dans la \autoref{fig:architecture-systeme-trusternity}.

\begin{figure}[!ht]
  \centering
  \includegraphics[page=4, trim=3cm 1cm 4cm 1cm, clip, width=.7\linewidth]{img/mute-figures.pdf}
  \caption{Architecture système pour la couche sécurité de MUTE}
  \label{fig:architecture-systeme-trusternity}
\end{figure}

Cette couche sécurité s'ajoute au mécanisme de chiffrement des messages inhérent à \ac{WebRTC}.
Cela nous offre de nouvelles possibilités : plutôt que de créer un réseau \ac{P2P} par document, nous pouvons désormais mettre en place un réseau \ac{P2P} global.
Les messages étant chiffrés de bout en bout, les noeuds peuvent communiquer en toute sécurité et confidentialité par l'intermédiaire de noeuds tiers, \ie des noeuds extérieurs à la collaboration.

Une limite de l'approche actuelle est que la clé de groupe change avec l'évolution des noeuds connectés : à chaque connexion ou déconnexion d'un noeud, une nouvelle clé est recalculée avec les collaborateur-rices présents.
Cette évolution fréquente de la clé de chiffrement, nécessaire pour garantir la \emph{backward secrecy} et \emph{forward secrecy}, nous empêche par exemple de stocker les opérations de manière chiffrée chez des noeuds tiers.
Cette fonctionnalité serait cependant bien pratique pour permettre à un noeud de récupérer la dernière version de ses documents, même en l'absence de ses collaborateur-rices.
Une autre clé de chiffrement, dédiée au stockage, devrait être mise en place, ainsi qu'un mécanisme de découverte des noeuds tiers stockant les données de la collaboration.

% \begin{itemize}
%   \item Librairies alternatives (libP2P, hypercore)
%   \item Topologies alternatives (SPRAY)
% \end{itemize}

\section{Conclusion}

Dans ce chapitre, nous avons présenté \acf{MUTE}, notre éditeur collaboratif temps réel \ac{P2P} chiffré de bout en bout.

MUTE permet d'éditer de manière collaborative des documents texte.
Pour représenter les documents, MUTE implémente les structures de données répliquées décrites dans la \autoref{sec:logootsplit} et le \autoref{chap:renamablelogootsplit}.
Ces \acp{CRDT} offrent de nouvelles méthodes de collaborer, notamment en permettant de collaborer de manière synchrone ou asynchrone de manière transparente.

Pour permettre aux noeuds de communiquer, MUTE utilise WebRTC.
Cette technologie permet de construire un réseau \ac{P2P} entre navigateurs.
Plusieurs serveurs sont néanmoins requis, notamment pour la découverte des pairs et pour la communication entre des noeuds dont les pare-feux respectifs empêche l'établissement d'une connexion directe.

Finalement, MUTE implémente un mécanisme de chiffrement de bout en bout garantissant l'authenticité et la confidentialité des échanges entre les noeuds.
Ce mécanisme reposant sur d'autres serveurs, les PKIs, MUTE intègre un mécanisme d'audit permettant de détecter leurs éventuels comportements malicieux.
